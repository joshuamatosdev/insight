package com.samgov.ingestor.service;

import com.samgov.ingestor.BaseServiceTest;
import com.samgov.ingestor.config.TenantContext;
import com.samgov.ingestor.exception.ResourceNotFoundException;
import com.samgov.ingestor.model.Contract;
import com.samgov.ingestor.model.Contract.ContractStatus;
import com.samgov.ingestor.model.Contract.ContractType;
import com.samgov.ingestor.model.Role;
import com.samgov.ingestor.model.ScopeChange.ChangeStatus;
import com.samgov.ingestor.model.ScopeChange.ChangePriority;
import com.samgov.ingestor.model.ScopeChange.ChangeType;
import com.samgov.ingestor.model.ScopeItem.ScopeItemType;
import com.samgov.ingestor.model.ScopeItem.ScopeStatus;
import com.samgov.ingestor.model.Tenant;
import com.samgov.ingestor.model.TenantMembership;
import com.samgov.ingestor.model.User;
import com.samgov.ingestor.repository.ContractRepository;
import com.samgov.ingestor.service.ScopeService.CreateScopeChangeRequest;
import com.samgov.ingestor.service.ScopeService.CreateScopeItemRequest;
import com.samgov.ingestor.service.ScopeService.ScopeChangeDto;
import com.samgov.ingestor.service.ScopeService.ScopeItemDto;
import com.samgov.ingestor.service.ScopeService.ScopeSummaryDto;
import com.samgov.ingestor.service.ScopeService.ScopeTreeNodeDto;
import com.samgov.ingestor.service.ScopeService.UpdateScopeItemRequest;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;

import java.math.BigDecimal;
import java.time.Instant;
import java.time.LocalDate;
import java.util.List;
import java.util.UUID;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

/**
 * Behavioral tests for ScopeService.
 *
 * Tests the business logic of scope management for contract portals:
 * - Scope item CRUD operations
 * - WBS tree structure management
 * - Scope change workflow (request, approve, reject)
 * - Summary calculations (completion %, remaining work)
 * - Multi-tenant isolation
 */
@DisplayName("ScopeService")
class ScopeServiceTest extends BaseServiceTest {

    @Autowired
    private ScopeService scopeService;

    @Autowired
    private ContractRepository contractRepository;

    private Contract testContract;
    private User adminUser;

    @BeforeEach
    @Override
    protected void setUp() {
        super.setUp();

        // Create admin user
        adminUser = User.builder()
            .email("admin-" + UUID.randomUUID().toString().substring(0, 8) + "@example.com")
            .passwordHash("$2a$10$test.hash.for.testing.only")
            .firstName("Admin")
            .lastName("User")
            .status(User.UserStatus.ACTIVE)
            .emailVerified(true)
            .build();
        adminUser = userRepository.save(adminUser);

        // Create admin role and membership
        Role adminRole = createTestRole(testTenant, Role.TENANT_ADMIN);
        TenantMembership adminMembership = TenantMembership.builder()
            .user(adminUser)
            .tenant(testTenant)
            .role(adminRole)
            .isDefault(true)
            .acceptedAt(Instant.now())
            .build();
        tenantMembershipRepository.save(adminMembership);

        // Create a test contract
        testContract = Contract.builder()
            .tenant(testTenant)
            .contractNumber("SCOPE-TEST-" + UUID.randomUUID().toString().substring(0, 8))
            .title("Scope Test Contract")
            .description("Contract for testing scope management")
            .contractType(ContractType.FIRM_FIXED_PRICE)
            .status(ContractStatus.ACTIVE)
            .agency("Department of Defense")
            .agencyCode("DOD")
            .popStartDate(LocalDate.now())
            .popEndDate(LocalDate.now().plusYears(1))
            .totalValue(new BigDecimal("500000.00"))
            .build();
        testContract = contractRepository.save(testContract);
    }

    private CreateScopeItemRequest createDefaultRequest(String wbsCode, String title, UUID parentId) {
        return new CreateScopeItemRequest(
            testContract.getId(),
            parentId,
            wbsCode,
            title,
            "Description for " + title,
            ScopeItemType.TASK,
            1, // priority
            new BigDecimal("40"), // estimatedHours
            new BigDecimal("100000.00"), // estimatedCost
            LocalDate.now(), // plannedStartDate
            LocalDate.now().plusMonths(1), // plannedEndDate
            testUser.getId(), // assignedToId
            testUser.getId(), // ownerId
            null, // clinId
            null, // deliverableId
            "Acceptance criteria", // acceptanceCriteria
            "Software Engineer", // laborCategory
            "Test notes", // notes
            true, // isBillable
            false // isMilestone
        );
    }

    @Nested
    @DisplayName("Scope Item CRUD Operations")
    class ScopeItemCrudOperations {

        @Test
        @DisplayName("should create a new scope item successfully")
        void shouldCreateScopeItemSuccessfully() {
            // Given
            CreateScopeItemRequest request = createDefaultRequest("1.0", "Phase 1", null);

            // When
            ScopeItemDto result = scopeService.createScopeItem(request);

            // Then
            assertThat(result).isNotNull();
            assertThat(result.id()).isNotNull();
            assertThat(result.wbsCode()).isEqualTo("1.0");
            assertThat(result.title()).isEqualTo("Phase 1");
            assertThat(result.estimatedCost()).isEqualByComparingTo(new BigDecimal("100000.00"));
            assertThat(result.estimatedHours()).isEqualByComparingTo(new BigDecimal("40"));
            assertThat(result.status()).isEqualTo(ScopeStatus.NOT_STARTED);
            assertThat(result.contractId()).isEqualTo(testContract.getId());
        }

        @Test
        @DisplayName("should retrieve scope item by ID")
        void shouldRetrieveScopeItemById() {
            // Given
            ScopeItemDto created = scopeService.createScopeItem(
                createDefaultRequest("1.0", "Phase 1", null)
            );

            // When
            ScopeItemDto result = scopeService.getScopeItem(created.id());

            // Then
            assertThat(result).isNotNull();
            assertThat(result.id()).isEqualTo(created.id());
            assertThat(result.title()).isEqualTo("Phase 1");
        }

        @Test
        @DisplayName("should throw ResourceNotFoundException for non-existent scope item")
        void shouldThrowExceptionForNonExistentScopeItem() {
            // Given
            UUID nonExistentId = UUID.randomUUID();

            // When/Then
            assertThatThrownBy(() -> scopeService.getScopeItem(nonExistentId))
                .isInstanceOf(ResourceNotFoundException.class);
        }

        @Test
        @DisplayName("should list scope items for a contract")
        void shouldListScopeItemsForContract() {
            // Given
            scopeService.createScopeItem(createDefaultRequest("1.0", "Phase 1", null));
            scopeService.createScopeItem(createDefaultRequest("2.0", "Phase 2", null));
            scopeService.createScopeItem(createDefaultRequest("3.0", "Phase 3", null));

            // When
            Page<ScopeItemDto> items = scopeService.getScopeItems(
                testContract.getId(),
                PageRequest.of(0, 10)
            );

            // Then
            assertThat(items.getContent()).hasSize(3);
        }

        @Test
        @DisplayName("should update scope item details")
        void shouldUpdateScopeItemDetails() {
            // Given
            ScopeItemDto created = scopeService.createScopeItem(
                createDefaultRequest("1.0", "Original Name", null)
            );

            UpdateScopeItemRequest updateRequest = new UpdateScopeItemRequest(
                "Updated Name",
                "Updated description",
                ScopeItemType.PHASE,
                2, // priority
                new BigDecimal("60"), // estimatedHours
                null, // actualHours
                null, // remainingHours
                new BigDecimal("150000.00"), // estimatedCost
                null, // actualCost
                50, // percentComplete
                null, // plannedStartDate
                null, // plannedEndDate
                null, // actualStartDate
                null, // actualEndDate
                null, // assignedToId
                null, // ownerId
                null, // clinId
                null, // deliverableId
                null, // acceptanceCriteria
                null, // laborCategory
                null, // notes
                null, // isBillable
                null  // isMilestone
            );

            // When
            ScopeItemDto result = scopeService.updateScopeItem(created.id(), updateRequest);

            // Then
            assertThat(result.title()).isEqualTo("Updated Name");
            assertThat(result.description()).isEqualTo("Updated description");
            assertThat(result.estimatedCost()).isEqualByComparingTo(new BigDecimal("150000.00"));
            assertThat(result.estimatedHours()).isEqualByComparingTo(new BigDecimal("60"));
            assertThat(result.percentComplete()).isEqualTo(50);
        }

        @Test
        @DisplayName("should delete scope item")
        void shouldDeleteScopeItem() {
            // Given
            ScopeItemDto created = scopeService.createScopeItem(
                createDefaultRequest("1.0", "To Delete", null)
            );

            // When
            scopeService.deleteScopeItem(created.id());

            // Then
            assertThatThrownBy(() -> scopeService.getScopeItem(created.id()))
                .isInstanceOf(ResourceNotFoundException.class);
        }

        @Test
        @DisplayName("should reject duplicate WBS codes within contract")
        void shouldRejectDuplicateWbsCode() {
            // Given
            scopeService.createScopeItem(createDefaultRequest("1.0", "First Item", null));

            // When/Then
            assertThatThrownBy(() -> scopeService.createScopeItem(
                createDefaultRequest("1.0", "Duplicate WBS", null)
            ))
                .isInstanceOf(IllegalArgumentException.class)
                .hasMessageContaining("WBS code already exists");
        }
    }

    @Nested
    @DisplayName("WBS Tree Structure")
    class WbsTreeStructure {

        @Test
        @DisplayName("should create hierarchical scope items")
        void shouldCreateHierarchicalScopeItems() {
            // Given - create parent
            ScopeItemDto parent = scopeService.createScopeItem(
                createDefaultRequest("1.0", "Phase 1", null)
            );

            // When - create children
            ScopeItemDto child1 = scopeService.createScopeItem(
                createDefaultRequest("1.1", "Task 1.1", parent.id())
            );
            ScopeItemDto child2 = scopeService.createScopeItem(
                createDefaultRequest("1.2", "Task 1.2", parent.id())
            );

            // Then
            assertThat(child1.parentId()).isEqualTo(parent.id());
            assertThat(child2.parentId()).isEqualTo(parent.id());

            // Verify children list via tree
            List<ScopeTreeNodeDto> tree = scopeService.getWbsTree(testContract.getId());
            assertThat(tree).hasSize(1);
            assertThat(tree.get(0).children()).hasSize(2);
        }

        @Test
        @DisplayName("should return full WBS tree for contract")
        void shouldReturnFullWbsTree() {
            // Given - create WBS structure
            ScopeItemDto phase1 = scopeService.createScopeItem(
                createDefaultRequest("1.0", "Phase 1", null)
            );
            scopeService.createScopeItem(createDefaultRequest("1.1", "Task 1.1", phase1.id()));
            scopeService.createScopeItem(createDefaultRequest("1.2", "Task 1.2", phase1.id()));

            ScopeItemDto phase2 = scopeService.createScopeItem(
                createDefaultRequest("2.0", "Phase 2", null)
            );
            scopeService.createScopeItem(createDefaultRequest("2.1", "Task 2.1", phase2.id()));

            // When
            List<ScopeTreeNodeDto> wbsTree = scopeService.getWbsTree(testContract.getId());

            // Then - should return top-level items with children
            assertThat(wbsTree).hasSize(2);
            assertThat(wbsTree)
                .extracting(ScopeTreeNodeDto::wbsCode)
                .containsExactly("1.0", "2.0");

            // Verify children are included
            ScopeTreeNodeDto treePhase1 = wbsTree.stream()
                .filter(i -> i.wbsCode().equals("1.0"))
                .findFirst()
                .orElseThrow();
            assertThat(treePhase1.children()).hasSize(2);
        }

        @Test
        @DisplayName("should return root items for contract")
        void shouldReturnRootItemsForContract() {
            // Given - create root items and children
            ScopeItemDto root1 = scopeService.createScopeItem(
                createDefaultRequest("1.0", "Root 1", null)
            );
            scopeService.createScopeItem(createDefaultRequest("1.1", "Child 1.1", root1.id()));

            ScopeItemDto root2 = scopeService.createScopeItem(
                createDefaultRequest("2.0", "Root 2", null)
            );

            // When
            List<ScopeItemDto> rootItems = scopeService.getRootItems(testContract.getId());

            // Then
            assertThat(rootItems).hasSize(2);
            assertThat(rootItems)
                .extracting(ScopeItemDto::title)
                .containsExactlyInAnyOrder("Root 1", "Root 2");
        }
    }

    @Nested
    @DisplayName("Scope Change Workflow")
    class ScopeChangeWorkflow {

        private ScopeItemDto scopeItem;

        @BeforeEach
        void createScopeItem() {
            scopeItem = scopeService.createScopeItem(
                createDefaultRequest("1.0", "Original Scope", null)
            );
        }

        @Test
        @DisplayName("should request scope change")
        void shouldRequestScopeChange() {
            // Given
            CreateScopeChangeRequest request = new CreateScopeChangeRequest(
                testContract.getId(),
                scopeItem.id(),
                "Change Request",
                "Need to increase estimated hours due to complexity",
                ChangeType.SCOPE_INCREASE,
                ChangePriority.MEDIUM,
                new BigDecimal("20"), // hoursImpact
                new BigDecimal("20000.00"), // costImpact
                5, // scheduleImpactDays
                "Impact analysis details",
                "Business justification",
                "Business case details",
                new BigDecimal("40"), // previousEstimatedHours
                new BigDecimal("60"), // newEstimatedHours
                new BigDecimal("100000.00"), // previousEstimatedCost
                new BigDecimal("120000.00"), // newEstimatedCost
                LocalDate.now().plusMonths(1), // previousEndDate
                LocalDate.now().plusMonths(1).plusDays(5), // newEndDate
                "John Doe", // requestorName
                "john.doe@example.com", // requestorEmail
                "EXT-001", // externalReference
                "Internal notes" // internalNotes
            );

            // When
            ScopeChangeDto changeRequest = scopeService.requestChange(request);

            // Then
            assertThat(changeRequest).isNotNull();
            assertThat(changeRequest.id()).isNotNull();
            assertThat(changeRequest.title()).isEqualTo("Change Request");
            assertThat(changeRequest.status()).isEqualTo(ChangeStatus.PENDING_APPROVAL);
            assertThat(changeRequest.hoursImpact()).isEqualByComparingTo(new BigDecimal("20"));
            assertThat(changeRequest.costImpact()).isEqualByComparingTo(new BigDecimal("20000.00"));
        }

        @Test
        @DisplayName("should approve scope change")
        void shouldApproveScopeChange() {
            // Given - create change request
            CreateScopeChangeRequest request = new CreateScopeChangeRequest(
                testContract.getId(),
                scopeItem.id(),
                "Approved Change",
                "Justification",
                ChangeType.SCOPE_INCREASE,
                ChangePriority.HIGH,
                new BigDecimal("40"),
                new BigDecimal("50000.00"),
                10,
                null, null, null, null, null, null, null, null, null, null, null, null, null
            );
            ScopeChangeDto changeRequest = scopeService.requestChange(request);

            // When
            ScopeChangeDto approved = scopeService.approveChange(changeRequest.id(), "Approved by PM");

            // Then
            assertThat(approved.status()).isEqualTo(ChangeStatus.APPROVED);
            assertThat(approved.approvalComments()).isEqualTo("Approved by PM");
            assertThat(approved.approvedDate()).isNotNull();
        }

        @Test
        @DisplayName("should reject scope change")
        void shouldRejectScopeChange() {
            // Given
            CreateScopeChangeRequest request = new CreateScopeChangeRequest(
                testContract.getId(),
                scopeItem.id(),
                "Rejected Change",
                "Justification",
                ChangeType.SCOPE_INCREASE,
                ChangePriority.LOW,
                new BigDecimal("100"),
                new BigDecimal("100000.00"),
                30,
                null, null, null, null, null, null, null, null, null, null, null, null, null
            );
            ScopeChangeDto changeRequest = scopeService.requestChange(request);

            // When
            ScopeChangeDto rejected = scopeService.rejectChange(changeRequest.id(), "Budget constraints");

            // Then
            assertThat(rejected.status()).isEqualTo(ChangeStatus.REJECTED);
            assertThat(rejected.rejectionReason()).isEqualTo("Budget constraints");
        }

        @Test
        @DisplayName("should list scope changes by status")
        void shouldListScopeChangesByStatus() {
            // Given - create multiple change requests
            scopeService.requestChange(new CreateScopeChangeRequest(
                testContract.getId(), scopeItem.id(), "Change 1", "Desc",
                ChangeType.SCOPE_INCREASE, ChangePriority.LOW,
                new BigDecimal("10"), new BigDecimal("10000"), 5,
                null, null, null, null, null, null, null, null, null, null, null, null, null
            ));
            scopeService.requestChange(new CreateScopeChangeRequest(
                testContract.getId(), scopeItem.id(), "Change 2", "Desc",
                ChangeType.SCOPE_DECREASE, ChangePriority.MEDIUM,
                new BigDecimal("-5"), new BigDecimal("-5000"), -2,
                null, null, null, null, null, null, null, null, null, null, null, null, null
            ));

            // When
            List<ScopeChangeDto> pendingChanges = scopeService.getScopeChanges(
                testContract.getId(), ChangeStatus.PENDING_APPROVAL
            );

            // Then
            assertThat(pendingChanges).hasSize(2);
            assertThat(pendingChanges).allMatch(c -> c.status() == ChangeStatus.PENDING_APPROVAL);
        }
    }

    @Nested
    @DisplayName("Summary Calculations")
    class SummaryCalculations {

        @Test
        @DisplayName("should calculate scope summary")
        void shouldCalculateScopeSummary() {
            // Given - create scope items with various states
            ScopeItemDto item1 = scopeService.createScopeItem(createDefaultRequest("1.0", "Completed Item", null));
            scopeService.updateStatus(item1.id(), ScopeStatus.COMPLETED);

            ScopeItemDto item2 = scopeService.createScopeItem(createDefaultRequest("2.0", "In Progress Item", null));
            scopeService.updateStatus(item2.id(), ScopeStatus.IN_PROGRESS);

            scopeService.createScopeItem(createDefaultRequest("3.0", "Not Started Item", null));

            // When
            ScopeSummaryDto summary = scopeService.getScopeSummary(testContract.getId());

            // Then
            assertThat(summary).isNotNull();
            assertThat(summary.totalItems()).isEqualTo(3);
            assertThat(summary.completedItems()).isEqualTo(1);
            assertThat(summary.inProgressItems()).isEqualTo(1);
            assertThat(summary.notStartedItems()).isEqualTo(1);
            assertThat(summary.totalEstimatedHours()).isEqualByComparingTo(new BigDecimal("120")); // 40 * 3
            assertThat(summary.totalEstimatedCost()).isEqualByComparingTo(new BigDecimal("300000.00")); // 100000 * 3
        }

        @Test
        @DisplayName("should return zero counts for empty scope")
        void shouldReturnZeroCountsForEmptyScope() {
            // When
            ScopeSummaryDto summary = scopeService.getScopeSummary(testContract.getId());

            // Then
            assertThat(summary.totalItems()).isZero();
            assertThat(summary.completedItems()).isZero();
            assertThat(summary.totalEstimatedHours()).isEqualByComparingTo(BigDecimal.ZERO);
            assertThat(summary.totalEstimatedCost()).isEqualByComparingTo(BigDecimal.ZERO);
        }
    }

    @Nested
    @DisplayName("Multi-Tenant Isolation")
    class MultiTenantIsolation {

        private Tenant tenant2;
        private User user2;
        private Contract tenant2Contract;

        @BeforeEach
        void setUpSecondTenant() {
            // Create second tenant
            tenant2 = Tenant.builder()
                .name("Second Tenant")
                .slug("second-tenant-" + UUID.randomUUID().toString().substring(0, 8))
                .build();
            tenant2 = tenantRepository.save(tenant2);

            // Create second user
            user2 = User.builder()
                .email("user2-" + UUID.randomUUID().toString().substring(0, 8) + "@example.com")
                .passwordHash("$2a$10$test.hash.for.testing.only")
                .firstName("Second")
                .lastName("User")
                .status(User.UserStatus.ACTIVE)
                .emailVerified(true)
                .build();
            user2 = userRepository.save(user2);

            // Create role and membership
            var role2 = createTestRole(tenant2, Role.USER);
            TenantMembership membership2 = TenantMembership.builder()
                .user(user2)
                .tenant(tenant2)
                .role(role2)
                .isDefault(true)
                .acceptedAt(Instant.now())
                .build();
            tenantMembershipRepository.save(membership2);

            // Create contract in tenant 2
            tenant2Contract = Contract.builder()
                .tenant(tenant2)
                .contractNumber("T2-SCOPE-" + UUID.randomUUID().toString().substring(0, 8))
                .title("Tenant 2 Contract")
                .contractType(ContractType.FIRM_FIXED_PRICE)
                .status(ContractStatus.ACTIVE)
                .agency("GSA")
                .popStartDate(LocalDate.now())
                .popEndDate(LocalDate.now().plusYears(1))
                .totalValue(new BigDecimal("300000.00"))
                .build();
            tenant2Contract = contractRepository.save(tenant2Contract);
        }

        @Test
        @DisplayName("should isolate scope items between tenants")
        void shouldIsolateScopeItemsBetweenTenants() {
            // Given - Create scope item in tenant 1
            ScopeItemDto tenant1Item = scopeService.createScopeItem(
                createDefaultRequest("1.0", "Tenant 1 Item", null)
            );

            // Switch to tenant 2
            switchTenant(tenant2);
            TenantContext.setCurrentUserId(user2.getId());

            // Create scope item in tenant 2 with tenant2Contract
            CreateScopeItemRequest tenant2Request = new CreateScopeItemRequest(
                tenant2Contract.getId(),
                null,
                "1.0", // Same WBS code - should be allowed in different tenant/contract
                "Tenant 2 Item",
                "Description",
                ScopeItemType.TASK,
                1,
                new BigDecimal("20"),
                new BigDecimal("50000.00"),
                LocalDate.now(),
                LocalDate.now().plusMonths(1),
                user2.getId(),
                user2.getId(),
                null, null, null, null, null, true, false
            );
            ScopeItemDto tenant2Item = scopeService.createScopeItem(tenant2Request);

            // Then - Each tenant should only see their own scope items
            Page<ScopeItemDto> tenant2Items = scopeService.getScopeItems(
                tenant2Contract.getId(),
                PageRequest.of(0, 10)
            );
            assertThat(tenant2Items.getContent())
                .extracting(ScopeItemDto::title)
                .contains("Tenant 2 Item")
                .doesNotContain("Tenant 1 Item");

            // Switch back to tenant 1
            switchTenant(testTenant);
            TenantContext.setCurrentUserId(testUser.getId());

            Page<ScopeItemDto> tenant1Items = scopeService.getScopeItems(
                testContract.getId(),
                PageRequest.of(0, 10)
            );
            assertThat(tenant1Items.getContent())
                .extracting(ScopeItemDto::title)
                .contains("Tenant 1 Item")
                .doesNotContain("Tenant 2 Item");
        }

        @Test
        @DisplayName("should not allow access to other tenant's scope item by ID")
        void shouldNotAllowCrossTenantScopeItemAccess() {
            // Given - Create scope item in tenant 1
            ScopeItemDto tenant1Item = scopeService.createScopeItem(
                createDefaultRequest("1.0", "Cross Tenant Test", null)
            );

            // Switch to tenant 2
            switchTenant(tenant2);
            TenantContext.setCurrentUserId(user2.getId());

            // When/Then - Attempting to access tenant 1's scope item should fail
            assertThatThrownBy(() -> scopeService.getScopeItem(tenant1Item.id()))
                .isInstanceOf(ResourceNotFoundException.class);
        }
    }
}
